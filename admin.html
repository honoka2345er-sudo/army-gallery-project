<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û (Admin Panel)</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c3e50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/1042/1042339.png">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* =========================================
           1. Global Settings
           ========================================= */
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #c0392b;
            --light-bg: #f8f9fa;
            --white: #ffffff;
            --text-dark: #333333;
            --text-muted: #7f8c8d;
            --border-color: #e0e0e0;
            --sidebar-width: 260px;
        }

        * {
            box-sizing: border-box;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background-color: var(--light-bg);
            display: flex;
            height: 100vh;
            overflow: hidden;
            color: var(--text-dark);
        }

        /* =========================================
           2. Sidebar (PC Layout)
           ========================================= */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 25px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            height: 100%;
            overflow-y: auto;
            transition: all 0.3s ease;
            z-index: 1000;
            position: relative;
            left: 0;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.05);
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-btn {
            display: none;
            background: none;
            border: none;
            color: var(--white);
            font-size: 24px;
            cursor: pointer;
        }

        .menu-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex-grow: 1;
        }

        .user-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .user-info p {
            margin: 0;
            color: #bdc3c7;
            font-size: 13px;
        }

        .user-info span {
            color: #f1c40f;
            font-weight: bold;
            font-size: 16px;
            display: block;
            margin-top: 5px;
            color: white;
        }

        .menu-link {
            color: var(--white);
            text-decoration: none;
            font-size: 16px;
            padding: 12px 15px;
            border-radius: 8px;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .menu-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .sidebar-footer {
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-profile {
            background: var(--primary-color);
            color: var(--white);
            border: none;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-logout {
            background: var(--danger-color);
            color: var(--white);
            border: none;
            padding: 12px;
            cursor: pointer;
            border-radius: 8px;
            font-family: 'Sarabun', sans-serif;
            font-weight: 600;
            width: 100%;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        /* =========================================
           3. Main Content Area
           ========================================= */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .mobile-nav {
            display: none;
            background-color: var(--secondary-color);
            color: var(--white);
            padding: 15px 20px;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 900;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .hamburger {
            background: none;
            border: none;
            color: var(--white);
            font-size: 26px;
            cursor: pointer;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            backdrop-filter: blur(2px);
        }

        /* =========================================
           4. Cards & Components
           ========================================= */
        .card {
            background: var(--white);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .card h3 {
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 5px;
            color: var(--secondary-color);
            margin-top: 0;
            margin-bottom: 10px !important;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--white);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border-left: 5px solid transparent;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-icon {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 48px;
            opacity: 0.1;
        }

        .stat-number {
            font-size: 42px;
            font-weight: 800;
            margin: 15px 0;
            color: var(--text-dark);
        }

        .stat-label {
            color: var(--text-muted);
            font-size: 16px;
            font-weight: 500;
        }

        /* Inputs & Forms */
        label {
            font-weight: 600;
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
        }

        input[type="text"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-sizing: border-box;
            margin-bottom: 15px;
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            height: 42px;
            outline: none;
        }

        input:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* File Upload */
        .file-upload-wrapper {
            position: relative;
            width: 100%;
            min-height: 160px;
            height: auto;
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #f0f8ff;
            color: var(--primary-color);
            cursor: pointer;
            flex-direction: column;
            transition: 0.3s;
            padding: 30px;
        }

        .file-upload-wrapper:hover {
            background: #e6f2ff;
        }

        .file-upload-wrapper input[type=file] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 2;
        }

        .upload-icon {
            font-size: 56px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-weight: 600;
            font-size: 18px;
        }

        /* Preview Grid */
        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            margin-top: 20px;
            width: 100%;
            z-index: 1;
        }

        .preview-img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--white);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Buttons */
        .btn-primary {
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-search {
            height: 42px;
            padding: 0 25px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-nav {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-weight: 500;
            transition: all 0.2s;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
        }

        .btn-nav:hover {
            background: #f0f0f0;
        }

        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 13px;
            color: var(--text-muted);
        }

        .btn-icon:hover {
            background: #f0f0f0;
            color: var(--text-dark);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .btn-icon.delete:hover {
            background: #fee2e2;
            color: var(--danger-color);
            border-color: #fecaca;
        }

        /* Toolbars */
        .search-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .bulk-toolbar {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #fff;
            border: 1px dashed #ccc;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .bulk-actions-right {
            display: flex;
            gap: 10px;
        }

        .btn-bulk-restore {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-bulk-delete {
            background-color: #c0392b;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Sarabun';
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Gallery Grid */
        .approval-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }

        .approval-item {
            border: 1px solid var(--border-color);
            padding: 10px;
            border-radius: 12px;
            text-align: center;
            background: var(--white);
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .approval-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .approval-item img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            border-radius: 8px;
            pointer-events: none;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        .approval-item.selected {
            border: 2px solid var(--success-color);
            background-color: #e8f8f5;
        }

        .approval-item.selected::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--success-color);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* Trash Design */
        .approval-item.trash-item {
            border: 2px dashed #ffb7b2;
            background-color: #fffbfb;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .approval-item.trash-item img {
            filter: grayscale(100%);
            opacity: 0.85;
            height: 160px;
            width: 100%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        /* Action Buttons inside Card */
        .trash-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 10px;
            border-top: 1px solid #f0e0e0;
            width: 100%;
            position: relative;
            z-index: 20; /* üî• Fix Click: Z-index Higher */
        }

        .btn-trash-action {
            flex: 1;
            padding: 8px 4px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: all 0.2s;
            font-family: 'Sarabun', sans-serif;
            background: white;
            white-space: nowrap;
        }

        .btn-trash-restore {
            border: 1px solid #3498db;
            color: #3498db;
        }

        .btn-trash-restore:hover {
            background-color: #3498db;
            color: white;
        }

        .btn-trash-delete {
            border: 1px solid #e74c3c;
            color: #e74c3c;
        }

        .btn-trash-delete:hover {
            background-color: #e74c3c;
            color: white;
        }

        .gallery-actions {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 4px;
            margin-top: auto;
            position: relative;
            z-index: 20; /* üî• Fix Click: Z-index Higher */
        }

        .btn-icon-action {
            width: 32px;
            height: 32px;
            padding: 0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
            font-size: 14px;
        }

        /* Tables */
        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 0px;
            background: white;
            min-width: 600px;
        }

        th {
            padding: 15px;
            border-bottom: 2px solid var(--border-color);
            text-align: left;
            font-size: 14px;
            color: #444;
            font-weight: 600;
            text-transform: uppercase;
            background: #f8f9fa;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            font-size: 15px;
            vertical-align: middle;
            color: #555;
        }

        .user-row:hover,
        .log-row:hover {
            background-color: #f9fafb;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid transparent;
        }
        
        .bg-login { background-color: #e8f5e9; color: #166534; }
        .bg-upload { background-color: #eff6ff; color: #1e40af; }
        .bg-delete { background-color: #fef2f2; color: #991b1b; }
        .bg-edit { background-color: #fff7ed; color: #9a3412; }
        .bg-other { background-color: #f3f4f6; color: #374151; }
        .bg-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .bg-fail { background-color: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .bg-warning { background-color: #ffedd5; color: #9a3412; border: 1px solid #fed7aa; }

        .user-cell {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            text-transform: uppercase;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .user-detail {
            display: flex;
            flex-direction: column;
        }

        .user-username {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
        }

        .user-id {
            font-size: 11px;
            color: var(--text-muted);
        }

        .role-badge {
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-admin { background-color: #f3e5f5; color: #8e44ad; border: 1px solid #e1bee7; }
        .badge-uploader { background-color: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }

        .action-btn-group {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        /* Pagination */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        #pageIndicator, #logPageIndicator {
            font-weight: bold;
            color: var(--secondary-color);
            font-size: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            padding-top: 50px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            max-height: 90vh;
            object-fit: contain;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        /* Custom Popup Styling */
        .small-modal-popup {
            width: 450px !important;
            max-width: 90% !important;
            padding: 30px !important;
            border-radius: 16px !important;
            background: #fff;
            box-sizing: content-box !important;
        }

        .small-modal-input {
            margin: 10px auto !important;
            width: 100% !important;
            height: 48px !important;
            border-radius: 8px !important;
            border: 2px solid #e0e0e0 !important;
            padding: 0 15px !important;
            box-sizing: border-box !important;
            font-size: 16px !important;
            box-shadow: none !important;
        }

        /* =========================================
           10. Mobile Responsive (The Fix)
           ========================================= */
        @media (max-width: 768px) {
            body { flex-direction: column; height: auto; overflow: auto; }
            .mobile-nav { display: flex; }
            .sidebar { position: fixed; left: -260px; top: 0; height: 100%; box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3); }
            .sidebar.active { left: 0; }
            .close-btn { display: block; }
            
            .main-content { padding: 80px 15px 30px 15px; }
            .stats-grid { grid-template-columns: 1fr; }
            #uploadForm>div { grid-template-columns: 1fr !important; gap: 20px !important; }
            
            .bulk-toolbar, .search-toolbar { flex-direction: column; align-items: stretch; }
            .bulk-actions-right { width: 100%; justify-content: space-between; }
            .btn-bulk-restore, .btn-bulk-delete { flex: 1; justify-content: center; }
            .card { padding: 20px; overflow-x: auto; }
            
            /* Gallery */
            .approval-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .approval-item img { height: 110px; }

            /* üî• Table to Card View Transformation */
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 10px; background: white; padding: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            td { border: none; position: relative; padding-left: 0; padding: 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0f0f0; }
            td:last-child { border-bottom: none; }
            td::before { content: attr(data-label); font-weight: 700; color: #555; font-size: 13px; margin-right: 10px; }
            
            .action-btn-group { justify-content: flex-end; }
        }
    </style>
</head>

<body>

    <div id="imageModal" class="modal" onclick="closeImage()">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="img01">
    </div>

    <div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

    <div class="mobile-nav">
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <span style="font-weight:bold; font-size:18px;">Admin Panel</span>
        </div>
    </div>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="font-size:24px;"><i class="fas fa-camera-retro"></i></span>
                <h2>Admin Panel</h2>
            </div>
            <button class="close-btn" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>

        <div class="menu-items">
            <div class="user-info">
                <p>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢:</p>
                <span id="showUsername">...</span>
            </div>
            <a href="index.html" target="_blank" class="menu-link"><i class="fas fa-external-link-alt"></i> ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏Å‡∏•‡πÄ‡∏•‡∏≠‡∏£‡∏µ</a>

            <div style="margin-top: auto;">
                <button onclick="openProfileSettings()" class="btn-profile"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</button>
                <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
            </div>
        </div>
    </div>

    <div class="main-content">

        <div class="stats-grid">
            <div class="stat-card" style="border-left: 5px solid #3498db;">
                <div class="stat-icon"><i class="fas fa-images"></i></div>
                <div class="stat-label">‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                <div class="stat-number" id="statTotal">0</div>
            </div>
            <div class="stat-card" style="border-left: 5px solid #2ecc71;">
                <div class="stat-icon"><i class="fas fa-folder"></i></div>
                <div class="stat-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
                <div class="stat-number" id="statCats">0</div>
            </div>
            <div class="stat-card admin-only" style="border-left: 5px solid #e74c3c;">
                <div class="stat-icon"><i class="fas fa-trash"></i></div>
                <div class="stat-label">‡πÉ‡∏ô‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</div>
                <div class="stat-number" id="statTrash">0</div>
            </div>
        </div>

        <div class="card admin-only" style="border-top: 5px solid #9b59b6;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                <h3 style="margin:0; display:flex; align-items:center; gap:10px; font-size:20px; color: #9b59b6;"> 
                    <i class="fas fa-hdd"></i> ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </h3>
                <button onclick="loadStorageStats()" class="btn-nav" style="padding: 4px 10px; font-size: 13px;"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>

            <div style="background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:15px; border: 1px solid #d2b4de;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                    <span style="font-weight:600; color:#555; font-size: 14px;">‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</span> 
                    <span id="storagePercentage" style="font-weight:bold; color:#9b59b6; font-size:18px;">0%</span> 
                </div>
                <div style="width:100%; height:26px; background:#ecf0f1; border-radius:15px; position:relative; overflow:hidden;">
                    <div id="storageBar" style="height:100%; background:linear-gradient(90deg, #3498db, #9b59b6); width:0%; transition:width 0.8s; display:flex; align-items:center; padding-left: 12px;">
                        <span id="storageBarText" style="color:#fff; font-weight:bold; font-size:13px; white-space: nowrap;">0.00%</span>
                    </div>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:12px; color:#7f8c8d;">
                    <span id="storageUsed">Bandwidth+Storage: 0 MB</span>
                    <span id="storageLimit">Plan Limit: ~25 GB</span>
                </div>
            </div>

            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:10px; margin-bottom:15px;">
                <div style="background:#e3f2fd; padding:12px; border-radius:12px; border-left:4px solid #2196f3;">
                    <div style="font-size:12px; color:#546e7a; margin-bottom:2px;">‡∏£‡∏π‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                    <div id="totalPhotosCount" style="font-size:22px; font-weight:bold; color:#2196f3;">0</div>
                </div>
                <div style="background:#fff3e0; padding:12px; border-radius:12px; border-left:4px solid #ff9800;">
                    <div style="font-size:12px; color:#5d4037; margin-bottom:2px;">‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
                    <div id="avgPhotoSize" style="font-size:22px; font-weight:bold; color:#ff9800;">0 MB</div>
                </div>
                <div style="background:#f3e5f5; padding:12px; border-radius:12px; border-left:4px solid #9c27b0;">
                    <div style="font-size:12px; color:#4a148c; margin-bottom:2px;">‡πÅ‡∏û‡∏•‡∏ô</div>
                    <div id="cloudinaryPlan" style="font-size:22px; font-weight:bold; color:#9c27b0;">FREE</div>
                </div>
            </div>

            <div id="topCategoriesList" style="max-height:200px; overflow-y:auto; padding-right:5px;">
                <p style="text-align:center; color:#999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>
        </div>

        <div class="card" style="border-top: 5px solid #3498db;">
            <div style="display:flex; align-items:center; gap:10px; margin-bottom:15px;">
                <h3 style="margin:0; font-size:20px; color: #3498db;">
                    <i class="fas fa-cloud-upload-alt"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </h3>
            </div>
            <form id="uploadForm">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="display:flex; flex-direction:column;">
                        <label style="font-size:14px; color:#555; margin-bottom:5px;"><b>1. ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</b></label>
                        <input type="text" id="categoryName" list="categoryList" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." required style="height: 42px; border-radius: 8px;">
                        <datalist id="categoryList"></datalist>
                    </div>
                    <div style="display:flex; flex-direction:column;">
                        <label style="font-size:14px; color:#555; margin-bottom:5px;"><b>2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</b></label>
                        <div class="file-upload-wrapper">
                            <div id="uploadPlaceholder" style="text-align: center;">
                                <span class="upload-icon" style="font-size: 32px; color: #3498db;"><i class="fas fa-images"></i></span>
                                <div class="upload-text" style="font-size: 14px; color: #3498db;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ / ‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û</div>
                            </div>
                            <div id="previewContainer" class="preview-grid" style="margin-top: 10px; gap: 10px;"></div>
                            <input type="file" id="fileInput" multiple accept="image/*" onchange="previewImages()">
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn-primary" style="width:100%; margin-top:15px; padding:10px;">
                    <i class="fas fa-upload"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                </button>
            </form>
        </div>

        <div class="card" style="border-top: 5px solid #2c3e50;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0; font-size:18px; color: #2c3e50;">
                    <i class="fas fa-images"></i> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </h3>
            </div>

            <div class="search-toolbar">
                <input type="text" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏π‡∏õ..." style="flex: 1; border-radius: 30px;">
                <select id="filterCategory" style="width: auto; min-width: 180px; border-radius: 30px;">
                    <option value="">üìÅ ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                </select>
                <button onclick="loadApprovedPhotos(1)" class="btn-search"><i class="fas fa-search"></i> ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
            </div>

            <div class="bulk-toolbar admin-only" id="approvedToolbar" style="display:none;">
                <button id="btnSelectAllApproved" class="btn-nav"><i class="fas fa-check-square"></i> ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                <button onclick="bulkDelete()" class="btn-bulk-delete"><i class="fas fa-trash"></i> ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
            </div>

            <div id="approvedList" class="approval-grid">
                <p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
            </div>

            <div class="pagination-container" id="paginationControls" style="display:none;">
                <button onclick="changePage(-1)" class="btn-page" id="btnPrev">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="pageIndicator">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button onclick="changePage(1)" class="btn-page" id="btnNext">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>

        <div class="card admin-only" style="border-top: 5px solid #e74c3c;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3><i class="fas fa-trash-alt"></i> ‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞</h3>
                <button onclick="loadTrash()" class="btn-page"><i class="fas fa-sync"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>
            
            <div class="bulk-toolbar" id="trashToolbar" style="display:none; justify-content: flex-end;">
                <button onclick="bulkRestoreTrash()" class="btn-bulk-restore">‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                <button onclick="bulkDeleteTrash()" class="btn-bulk-delete">‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>
            </div>

            <div id="trashList" class="approval-grid">
                <p style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
            </div>
        </div>

        <div class="card admin-only">
            <h3><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h3>
            <div class="table-container">
                <table class="log-table">
                    <thead><tr><th>‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</th><th>‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥</th><th>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</th></tr></thead>
                    <tbody id="logTableBody"><tr><td colspan="4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
                </table>
            </div>
            <div class="pagination-container" id="logPaginationControls" style="display:none;">
                <button onclick="changeLogPage(-1)" class="btn-page" id="btnLogPrev">‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <span id="logPageIndicator">‡∏´‡∏ô‡πâ‡∏≤ 1</span>
                <button onclick="changeLogPage(1)" class="btn-page" id="btnLogNext">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
            </div>
        </div>

        <div class="card admin-only" style="border-top: 5px solid #8e44ad;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3><i class="fas fa-users-cog"></i> ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h3>
                <button onclick="openAddUserModal()" class="btn-primary" style="background:#8e44ad; width:auto; border-radius: 30px;">
                    <i class="fas fa-user-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
                </button>
            </div>
            <div style="margin-bottom: 5px;">
                <input type="text" id="userSearch" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." style="width:100%; border-radius: 30px; padding-left:15px;" onkeyup="filterUsers()">
            </div>
            <div class="table-container">
                <table class="user-table">
                    <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</th><th>‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó</th><th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th></tr></thead>
                    <tbody id="userTableBody"><tr><td colspan="3">‡πÇ‡∏´‡∏•‡∏î...</td></tr></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // --- CORE SCRIPT ---
        if('serviceWorker' in navigator) navigator.serviceWorker.register('sw.js').catch(()=>{});
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        if(!user || !token) window.location.href = 'login.html';
        document.getElementById('showUsername').innerText = user.username;
        if(user.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.style.display='none');

        let currentPage=1, itemsPerPage=50, allLogsData=[], allUsersData=[];

        function getAuthHeaders() { return { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }; }

        // --- RENDER GALLERY (FIXED CLICK) ---
        function renderGrid(elemId, photos, type) {
            const el = document.getElementById(elemId); el.innerHTML = '';
            if(!photos.length) { el.innerHTML='<p style="grid-column:1/-1;text-align:center;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>'; return; }
            
            photos.forEach(p => {
                const id = p.id || p.photo_id;
                const url = p.url || `/uploads/${p.file_path}`;
                const safeFilename = (p.filename || 'No Name').replace(/'/g, "\\'");
                const dateVal = p.date || '';
                const actVal = p.activity || '';
                let btns = '';
                
                // üî• FIX: ‡πÉ‡∏ä‡πâ event.stopPropagation() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏ã‡πâ‡∏≠‡∏ô
                if(type === 'trash') {
                    btns = `<div class="trash-actions">
                        <button onclick="event.stopPropagation(); restorePhoto(${id})" class="btn-trash-action btn-trash-restore"><i class="fas fa-trash-restore"></i> ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô</button>
                        <button onclick="event.stopPropagation(); permanentDelete(${id})" class="btn-trash-action btn-trash-delete"><i class="fas fa-times-circle"></i> ‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£</button>
                    </div>`;
                } else if(user.role === 'admin') {
                    btns = `<div class="gallery-actions">
                        <button onclick="event.stopPropagation(); copyLink('${url}')" class="btn-icon-action" style="background:#3498db;"><i class="fas fa-link"></i></button>
                        <button onclick="event.stopPropagation(); editDetails(${id},'${actVal}','${dateVal}')" class="btn-icon-action" style="background:#f39c12;"><i class="fas fa-pen"></i></button>
                        <button onclick="event.stopPropagation(); softDelete(${id})" class="btn-icon-action" style="background:#e74c3c;"><i class="fas fa-trash"></i></button>
                    </div>`;
                }
                
                const chk = (user.role==='admin') ? `<input type="checkbox" class="check-overlay ${type}-check" value="${id}" onclick="event.stopPropagation()">` : '';
                el.innerHTML += `<div class="approval-item ${type==='trash'?'trash-item':''}" onclick="toggleSel(this)">${chk}<img src="${url}" onclick="event.stopPropagation(); openImage('${url}')">${btns}</div>`;
            });

            // Bulk Logic
            const btnAll = document.getElementById(type=='approved'?'btnSelectAllApproved':'btnSelectAllTrash');
            if(btnAll && user.role==='admin') {
                btnAll.onclick = () => {
                    const chks = document.querySelectorAll(`.${type}-check`);
                    const s = !chks[0].checked;
                    chks.forEach(c => { c.checked = s; c.parentElement.classList.toggle('selected', s); });
                };
            }
        }

        // --- Functions ---
        function toggleSel(el) {
            if(event.target.tagName==='BUTTON' || event.target.closest('button')) return;
            const c = el.querySelector('input');
            if(c) { c.checked = !c.checked; el.classList.toggle('selected', c.checked); }
        }

        async function restorePhoto(id) {
            if(await cf('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ?')) {
                await fetch('/photos/trash/restore', {method:'POST', headers:getAuthHeaders(), body:JSON.stringify({photo_ids:[id]})});
                loadTrash(); loadApprovedPhotos(currentPage);
            }
        }
        
        async function permanentDelete(id) {
            if(await cf('‡∏•‡∏ö‡∏ñ‡∏≤‡∏ß‡∏£?')) {
                await fetch('/photos/trash/empty', {method:'DELETE', headers:getAuthHeaders(), body:JSON.stringify({photo_ids:[id]})});
                loadTrash();
            }
        }

        async function softDelete(id) {
            if(await cf('‡∏•‡∏ö‡∏•‡∏á‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞?')) {
                await fetch(`/photos/${id}/soft-delete`, {method:'DELETE', headers:getAuthHeaders()});
                loadApprovedPhotos(currentPage);
            }
        }

        async function bulkRestoreTrash() { const ids=Array.from(document.querySelectorAll('.trash-check:checked')).map(c=>c.value); if(ids.length) { await fetch('/photos/trash/restore',{method:'POST',headers:getAuthHeaders(),body:JSON.stringify({photo_ids:ids})}); loadTrash(); loadApprovedPhotos(currentPage); } }
        async function bulkDeleteTrash() { const ids=Array.from(document.querySelectorAll('.trash-check:checked')).map(c=>c.value); if(ids.length && await cf('‡∏•‡∏ö‡∏´‡∏°‡∏î?')) { await fetch('/photos/trash/empty',{method:'DELETE',headers:getAuthHeaders(),body:JSON.stringify({photo_ids:ids})}); loadTrash(); } }
        async function bulkDelete() { const ids=Array.from(document.querySelectorAll('.approved-check:checked')).map(c=>c.value); if(ids.length && await cf('‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å?')) { await fetch('/photos/bulk-delete',{method:'POST',headers:getAuthHeaders(),body:JSON.stringify({photo_ids:ids})}); loadApprovedPhotos(currentPage); } }

        // --- DATA LOAD ---
        async function loadTrash() { const r=await fetch('/photos/trash?t='+Date.now(),{headers:getAuthHeaders()}); const d=await r.json(); renderGrid('trashList', d, 'trash'); document.getElementById('trashToolbar').style.display=d.length?'flex':'none'; }
        async function loadApprovedPhotos(p) { currentPage=p; const s=document.getElementById('searchInput').value; const c=document.getElementById('filterCategory').value; const r=await fetch(`/photos?page=${p}&limit=${itemsPerPage}&search=${s}&category=${c}&t=`+Date.now()); const d=await r.json(); renderGrid('approvedList', d, 'approved'); document.getElementById('pageIndicator').innerText=`‡∏´‡∏ô‡πâ‡∏≤ ${p}`; document.getElementById('paginationControls').style.display='flex'; document.getElementById('btnPrev').disabled=(p<=1); document.getElementById('btnNext').disabled=(d.length<itemsPerPage); if(user.role==='admin'&&d.length) document.getElementById('approvedToolbar').style.display='flex'; }

        // --- HELPERS ---
        function changePage(n) { if(currentPage+n>0) loadApprovedPhotos(currentPage+n); }
        function openImage(u) { document.getElementById('imageModal').style.display='block'; document.getElementById('img01').src=u; }
        function closeImage() { document.getElementById('imageModal').style.display='none'; }
        function copyLink(u) { navigator.clipboard.writeText(u); Swal.fire({toast:true,position:'top-end',icon:'success',title:'‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å',timer:1000,showConfirmButton:false}); }
        function toggleSidebar() { const sb=document.getElementById('sidebar'); const ov=document.getElementById('overlay'); if(sb.classList.contains('active')){sb.classList.remove('active');ov.style.display='none';}else{sb.classList.add('active');ov.style.display='block';} }
        async function cf(m) { const r=await Swal.fire({title:m, showCancelButton:true, confirmButtonText:'‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô'}); return r.isConfirmed; }
        function logout() { localStorage.clear(); location.href='login.html'; }
        
        // --- LOADERS ---
        async function loadStats() { try{const r=await fetch('/stats?t='+Date.now()); const d=await r.json(); document.getElementById('statTotal').innerText=d.total_photos; document.getElementById('statTrash').innerText=d.trash_count; document.getElementById('statCats').innerText=d.total_categories;}catch(e){} }
        async function loadStorageStats() { try{const r=await fetch('/storage/usage?t='+Date.now(),{headers:getAuthHeaders()}); const d=await r.json(); const p=((d.cloudinary.used_bytes/d.cloudinary.limit_bytes)*100).toFixed(2); document.getElementById('storageBar').style.width=p+'%'; document.getElementById('storagePercentage').innerText=p+'%'; document.getElementById('storageUsed').innerText='Used: '+d.cloudinary.used_readable;}catch(e){} }
        async function loadCategories() { try{const r=await fetch('/categories?t='+Date.now()); const c=await r.json(); const dl=document.getElementById('categoryList'),fl=document.getElementById('filterCategory'); dl.innerHTML=''; fl.innerHTML='<option value="">üìÅ ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>'; c.forEach(i=>{dl.innerHTML+=`<option value="${i.name}"></option>`; fl.innerHTML+=`<option value="${i.name}">${i.name}</option>`;});}catch(e){} }

        // --- UPLOAD ---
        function previewImages() { const c=document.getElementById('previewContainer'); c.innerHTML=''; Array.from(document.getElementById('fileInput').files).forEach(f=>{ const i=document.createElement('img'); i.src=URL.createObjectURL(f); i.className='preview-img'; c.appendChild(i); }); }
        document.getElementById('uploadForm').onsubmit = async (e)=>{ e.preventDefault(); const fd=new FormData(); fd.append('category_name', document.getElementById('categoryName').value); Array.from(document.getElementById('fileInput').files).forEach(f=>fd.append('photos', f)); Swal.showLoading(); const r=await fetch('/upload',{method:'POST',headers:{'Authorization':`Bearer ${token}`},body:fd}); if(r.ok){Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success'); setTimeout(()=>location.reload(),1000);}else Swal.fire('‡∏û‡∏•‡∏≤‡∏î','','error'); };

        // --- LOGS & USERS ---
        async function loadLogs() { try{const r=await fetch('/logs?t='+Date.now(),{headers:getAuthHeaders()}); const d=await r.json(); allLogsData=d; renderLogs(); }catch(e){} }
        function renderLogs() { const tb=document.getElementById('logTableBody'); tb.innerHTML=''; const st=(currentLogPage-1)*10; const sb=allLogsData.slice(st,st+10); if(!sb.length){tb.innerHTML='<tr><td colspan="4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';return;} document.getElementById('logPaginationControls').style.display='flex'; sb.forEach(l=>{ tb.innerHTML+=`<tr><td data-label="‡πÄ‡∏ß‡∏•‡∏≤">${new Date(l.created_at).toLocaleString('th-TH')}</td><td data-label="‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ">${l.username}</td><td data-label="‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥">${l.action}</td><td data-label="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">${l.details}</td></tr>`; }); document.getElementById('logPageIndicator').innerText=`‡∏´‡∏ô‡πâ‡∏≤ ${currentLogPage}`; }
        function changeLogPage(n) { currentLogPage+=n; renderLogs(); }

        async function loadUsers() { const r=await fetch('/users?t='+Date.now(),{headers:getAuthHeaders()}); allUsersData=await r.json(); renderUsers(allUsersData); }
        function renderUsers(l) { const tb=document.getElementById('userTableBody'); tb.innerHTML=''; l.forEach(u=>{ tb.innerHTML+=`<tr><td data-label="‡∏ä‡∏∑‡πà‡∏≠">${u.username}</td><td data-label="‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó">${u.role}</td><td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£"><div class="action-btn-group"><button onclick="changePass(${u.user_id})" class="btn-icon"><i class="fas fa-key"></i></button><button onclick="deleteUser(${u.user_id})" class="btn-icon" style="color:red"><i class="fas fa-trash"></i></button></div></td></tr>`; }); }
        function filterUsers() { const v=document.getElementById('userSearch').value.toLowerCase(); renderUsers(allUsersData.filter(u=>u.username.toLowerCase().includes(v))); }
        async function openAddUserModal() { const{value:f}=await Swal.fire({title:'‡πÄ‡∏û‡∏¥‡πà‡∏°',html:'<input id="u" placeholder="User"><input id="p" placeholder="Pass"><select id="r"><option value="uploader">Uploader</option><option value="admin">Admin</option></select>',preConfirm:()=>[document.getElementById('u').value,document.getElementById('p').value,document.getElementById('r').value]}); if(f) await fetch('/users',{method:'POST',headers:getAuthHeaders(),body:JSON.stringify({username:f[0],password:f[1],role:f[2]})}); loadUsers(); }
        async function changePass(id) { const{value:p}=await Swal.fire({title:'‡∏£‡∏´‡∏±‡∏™‡πÉ‡∏´‡∏°‡πà',input:'text'}); if(p) await fetch(`/users/${id}/reset`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify({newPassword:p})}); }
        async function deleteUser(id) { if(await cf('‡∏•‡∏ö?')) { await fetch(`/users/${id}`,{method:'DELETE',headers:getAuthHeaders()}); loadUsers(); } }
        async function editDetails(id,c,d) { const{value:f}=await Swal.fire({title:'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç',html:`<input id="sw1" value="${c}"><input id="sw2" type="datetime-local" value="${d?new Date(d).toISOString().slice(0,16):''}">`,preConfirm:()=>[document.getElementById('sw1').value,document.getElementById('sw2').value]}); if(f) { await fetch(`/photos/${id}/details`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify({category_name:f[0],custom_date:f[1]})}); loadApprovedPhotos(currentPage); } }
        async function openProfileSettings() { const{isConfirmed}=await Swal.fire({title:'‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤',showCancelButton:true,confirmButtonText:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™'}); if(isConfirmed) { const{value:f}=await Swal.fire({html:'<input id="op" placeholder="‡πÄ‡∏î‡∏¥‡∏°"><input id="np" placeholder="‡πÉ‡∏´‡∏°‡πà">',preConfirm:()=>[document.getElementById('op').value,document.getElementById('np').value]}); if(f) await fetch('/profile/password',{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify({oldPassword:f[0],newPassword:f[1]})}); } }

        (async function(){ await Promise.all([loadStats(), loadCategories(), loadApprovedPhotos(1)]); if(user.role==='admin'){ await loadLogs(); await loadTrash(); await loadStorageStats(); await loadUsers(); } })();
    </script>
</body>
</html>