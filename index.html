<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏†.3</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script> 
</head>
<body>

    <a href="login.html" style="position: absolute; right: 20px; top: 20px; text-decoration: none; color: #333; font-size: 14px; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000; font-weight: bold; transition: 0.3s;">
        üîí ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà
    </a>

    <header class="header-container">
        <img src="Royal_Thai_Army_3_Logo.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        <h1 class="header-title">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏†.3</h1>
    </header>

    <div class="search-section" style="background:#f8f9fa; padding:20px; border-bottom:1px solid #ddd; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..." onkeyup="resetAndFetch()" style="margin:0;">
        <input type="text" id="dateRange" class="search-input" placeholder="üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤..." style="width:220px; margin:0; text-align:center;">
        <button onclick="resetFilter()" style="padding:0 15px; border:none; background:#bdc3c7; color:white; border-radius:30px; cursor:pointer;">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div id="gallery">
        <p style="text-align: center; padding: 20px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£...</p>
    </div>

    <div id="loadMoreContainer" style="text-align:center; margin: 30px; display:none;">
        <button onclick="loadMore()" style="padding:10px 30px; background:#2c3e50; color:white; border:none; border-radius:20px; cursor:pointer; font-size:14px; transition:0.3s;">‚¨áÔ∏è ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>

    <script>
        let allPhotos = [];       
        let filteredPhotos = [];  
        let currentDisplayCount = 0; 
        const ITEMS_PER_PAGE = 12;   // ‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡∏•‡∏∞ 12 ‡∏£‡∏π‡∏õ
        
        let lightbox;
        let selectedDates = [];

        const datePicker = flatpickr("#dateRange", {
            mode: "range", dateFormat: "Y-m-d", locale: "th",
            onClose: function(dates) { selectedDates = dates; resetAndFetch(); }
        });

        async function fetchPhotos() {
            try {
                // üî• ‡πÉ‡∏ä‡πâ Relative Path (/photos) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Server ‡∏à‡∏£‡∏¥‡∏á
                const response = await fetch('/photos?limit=1000'); 
                allPhotos = await response.json();
                filteredPhotos = allPhotos; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                
                resetGallery(); // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('gallery').innerHTML = '<p style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>';
            }
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Å‡∏£‡∏≠‡∏á (Search & Date)
        function resetAndFetch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            
            filteredPhotos = allPhotos.filter(photo => {
                const matchName = photo.filename.toLowerCase().includes(keyword) || 
                                  (photo.activity && photo.activity.toLowerCase().includes(keyword));
                
                let matchDate = true;
                if (selectedDates.length > 0) {
                    const photoDate = new Date(photo.date).setHours(0,0,0,0);
                    const startDate = selectedDates[0].setHours(0,0,0,0);
                    const endDate = (selectedDates.length > 1) ? selectedDates[1].setHours(23,59,59,999) : startDate;
                    matchDate = (photoDate >= startDate && photoDate <= endDate);
                }
                return matchName && matchDate;
            });
            
            resetGallery();
        }

        function resetGallery() {
            document.getElementById('gallery').innerHTML = '';
            currentDisplayCount = 0;
            
            if (filteredPhotos.length === 0) {
                document.getElementById('gallery').innerHTML = '<p style="text-align: center; padding: 40px; color: #999;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>';
                document.getElementById('loadMoreContainer').style.display = 'none';
            } else {
                loadMore(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∏‡∏î‡πÅ‡∏£‡∏Å
            }
        }

        function loadMore() {
            const galleryContainer = document.getElementById('gallery');
            const nextPhotos = filteredPhotos.slice(currentDisplayCount, currentDisplayCount + ITEMS_PER_PAGE);
            
            if (nextPhotos.length === 0) return;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°
            const groupedPhotos = {};
            nextPhotos.forEach(photo => {
                const activityName = photo.activity || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                if (!groupedPhotos[activityName]) groupedPhotos[activityName] = [];
                groupedPhotos[activityName].push(photo);
            });

            for (const [activityName, activityPhotos] of Object.entries(groupedPhotos)) {
                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏´‡∏°? (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏¥‡∏°‡∏£‡∏π‡∏õ‡πÉ‡∏™‡πà‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°)
                let section = document.getElementById(`sec-${activityName}`);
                let grid;

                if (!section) {
                    section = document.createElement('div');
                    section.className = 'activity-section';
                    section.id = `sec-${activityName}`;
                    
                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'display:flex; align-items:center; gap:15px; margin-bottom:15px;';
                    
                    const title = document.createElement('h2');
                    title.className = 'activity-title';
                    title.style.marginBottom = '0';
                    title.innerText = activityName; 
                    
                    const zipBtn = document.createElement('a');
                    // üî• ‡πÉ‡∏ä‡πâ Relative Path (/download-zip)
                    zipBtn.href = `/download-zip/${encodeURIComponent(activityName)}`;
                    zipBtn.innerHTML = 'üì• ‡πÇ‡∏´‡∏•‡∏î ZIP';
                    zipBtn.style.cssText = 'font-size:12px; color:#fff; background:#3498db; padding:5px 10px; border-radius:4px; text-decoration:none; transition:0.2s;';
                    zipBtn.onmouseover = function() { this.style.background = '#2980b9'; };
                    zipBtn.onmouseout = function() { this.style.background = '#3498db'; };

                    headerDiv.appendChild(title);
                    headerDiv.appendChild(zipBtn);
                    section.appendChild(headerDiv);
                    
                    grid = document.createElement('div');
                    grid.className = 'gallery'; 
                    section.appendChild(grid);
                    galleryContainer.appendChild(section);
                } else {
                    grid = section.querySelector('.gallery');
                }

                activityPhotos.forEach(photo => {
                    const rawName = photo.filename || photo.file_name || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û";
                    const newsTitle = rawName.replace ? rawName.replace(/\.[^/.]+$/, "") : rawName;
                    const dateObj = new Date(photo.date);
                    const dateStr = dateObj.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });

                    const card = document.createElement('a');
                    card.className = 'news-card';
                    card.href = photo.original_url;  
                    
                    // üî• ‡∏î‡∏µ‡πÑ‡∏ã‡∏ô‡πå: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå + ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏•‡∏≤‡∏á
                    card.innerHTML = `
                        <div class="news-img-wrapper">
                            <img src="${photo.url}" alt="${newsTitle}" loading="lazy">
                        </div>
                        <div class="news-title" style="text-align:left; padding:10px; height:auto;">
                            <span style="font-size:13px; color:#7f8c8d;">üìÖ ${dateStr}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            currentDisplayCount += nextPhotos.length;

            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏ä‡∏ß‡πå‡∏õ‡∏∏‡πà‡∏° Load More ‡πÑ‡∏´‡∏°
            if (currentDisplayCount >= filteredPhotos.length) {
                document.getElementById('loadMoreContainer').style.display = 'none';
            } else {
                document.getElementById('loadMoreContainer').style.display = 'block';
            }

            // Refresh Lightbox
            if(lightbox) lightbox.refresh();
            else lightbox = new SimpleLightbox('.gallery a', { captionsData: 'alt', captionDelay: 250, animationSpeed: 200 });
        }

        function resetFilter() {
            document.getElementById('searchInput').value = '';
            datePicker.clear();
            resetAndFetch();
        }

        fetchPhotos();
    </script>

</body>
</html>