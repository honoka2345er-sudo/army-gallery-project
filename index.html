<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏†.3</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

    <style>
        /* --- Global Reset & Variables --- */
        * {
            box-sizing: border-box;
            transition: background-color 0.3s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s, border-color 0.3s;
        }

        :root {
            /* ‚òÄÔ∏è Light Mode */
            --primary: #c0392b;
            --bg-body: #ffffff;
            --bg-card: #ffffff;
            --bg-header: #ffffff;
            --bg-search: #f8f9fa;
            --text-main: #333333;
            --text-muted: #64748b;
            --border-color: #f1f5f9;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --input-border: #e2e8f0;
            --theme-icon-color: #333;
        }

        /* üåô Dark Mode */
        [data-theme="dark"] {
            --primary: #ff6b6b;
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-header: #1f2937;
            --bg-search: #0f172a;
            --text-main: #f3f4f6;
            --text-muted: #9ca3af;
            --border-color: #374151;
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --input-bg: #374151;
            --input-border: #4b5563;
            --theme-icon-color: #fbbf24;
        }

        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            overflow-y: scroll;
        }

        /* --- HEADER --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px 20px;
            background-color: var(--bg-header);
            gap: 25px;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .logo-link {
            display: block;
            text-decoration: none;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .logo-link:hover {
            transform: scale(1.1);
        }

        .header-logo {
            width: 80px;
            height: auto;
            display: block;
        }

        .header-title {
            font-size: 32px;
            font-weight: 600;
            margin: 0;
            color: var(--text-main);
            line-height: 1.2;
            cursor: default;
        }

        /* --- SEARCH SECTION --- */
        .search-section {
            background: var(--bg-search);
            padding: 25px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .search-container {
            display: flex;
            gap: 15px;
            align-items: center;
            width: 100%;
            max-width: 900px;
            flex-wrap: wrap;
        }

        .search-input {
            padding: 12px 25px;
            border: 1px solid var(--input-border);
            border-radius: 50px;
            font-size: 15px;
            font-family: 'Sarabun';
            outline: none;
            background: var(--input-bg);
            color: var(--text-main);
            box-shadow: var(--shadow-sm);
            flex: 2;
            min-width: 250px;
            height: 48px;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.25);
        }

        .date-input {
            text-align: center;
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 15px center;
            padding-left: 45px;
            flex: 1;
            min-width: 200px;
            height: 48px;
        }

        [data-theme="dark"] .date-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Crect x='3' y='4' width='18' height='18' rx='2' ry='2'%3E%3C/rect%3E%3Cline x1='16' y1='2' x2='16' y2='6'%3E%3C/line%3E%3Cline x1='8' y1='2' x2='8' y2='6'%3E%3C/line%3E%3Cline x1='3' y1='10' x2='21' y2='10'%3E%3C/line%3E%3C/svg%3E");
        }

        .btn-clear {
            padding: 0 25px;
            height: 48px;
            border: none;
            background: var(--input-bg);
            color: var(--text-muted);
            border-radius: 50px;
            cursor: pointer;
            font-size: 14px;
            font-family: 'Sarabun';
            font-weight: 500;
            white-space: nowrap;
            border: 1px solid var(--input-border);
        }

        .btn-clear:hover {
            background: var(--border-color);
            color: var(--text-main);
        }

        /* --- GALLERY GRID --- */
        .gallery-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .activity-section {
            margin-bottom: 60px;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-left: 15px;
            border-left: 5px solid var(--primary);
        }

        .activity-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--text-main);
            margin: 0;
        }

        /* üî• ‡∏õ‡∏∏‡πà‡∏° Download ZIP (‡πÉ‡∏ä‡πâ button ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏°‡∏î‡πâ‡∏ß‡∏¢ JS) */
        .btn-download-zip {
            font-size: 13px;
            color: var(--primary);
            text-decoration: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            white-space: nowrap;
            font-family: 'Sarabun', sans-serif;
            cursor: pointer;
        }

        .btn-download-zip:hover {
            border-color: var(--primary);
            background: var(--bg-search);
            transform: translateY(-2px);
        }

        .sub-gallery {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 25px;
        }

        .news-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            text-decoration: none;
            box-shadow: var(--shadow-card);
            border: 1px solid var(--border-color);
            position: relative;
        }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.2);
        }

        .news-img-wrapper {
            width: 100%;
            height: 220px;
            overflow: hidden;
            background: var(--bg-search);
            position: relative;
        }

        .news-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.6s ease, opacity 0.5s ease;
            opacity: 0;
        }

        .news-img-wrapper img.loaded {
            opacity: 1;
        }

        .news-card:hover .news-img-wrapper img {
            transform: scale(1.08);
        }

        .news-info {
            padding: 15px;
            border-top: 1px solid var(--border-color);
        }

        .news-date {
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Skeleton & Loader */
        .skeleton {
            background: var(--bg-search);
            background: linear-gradient(90deg, var(--bg-search) 25%, var(--border-color) 50%, var(--bg-search) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-card {
            background: var(--bg-card);
            border-radius: 16px;
            overflow: hidden;
            height: 280px;
            border: 1px solid var(--border-color);
        }

        .skeleton-img {
            width: 100%;
            height: 220px;
        }

        .skeleton-text {
            height: 16px;
            width: 60%;
            margin: 15px;
            border-radius: 4px;
        }

        #scroll-sentinel {
            height: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .loader-spinner {
            border: 3px solid var(--border-color);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* üî• BACK TO TOP BUTTON */
        #btnBackToTop {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 999;
            background: var(--primary);
            color: white;
            transition: transform 0.2s;
        }

        #btnBackToTop:hover {
            transform: scale(1.1);
        }

        /* üî• MINIMAL THEME TOGGLE */
        #btnThemeToggle {
            position: fixed;
            top: 25px;
            right: 25px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            color: var(--theme-icon-color);
            transition: all 0.2s ease;
        }

        [data-theme="light"] #btnThemeToggle {
            background: #f1f5f9;
            color: #333;
        }

        [data-theme="dark"] #btnThemeToggle {
            background: rgba(255, 255, 255, 0.1);
            color: #fbbf24;
        }

        #btnThemeToggle:hover {
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
        }

        #btnThemeToggle svg {
            width: 22px;
            height: 22px;
            fill: currentColor;
        }

        /* üî• Download Button (Lightbox) - Version Mobile Friendly */
        .sl-download-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 2147483647 !important; 
            background: var(--primary);
            color: white;
            text-decoration: none;
            padding: 10px 24px;
            border-radius: 30px;
            font-family: 'Sarabun';
            font-weight: 600;
            font-size: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: none;
            cursor: pointer;
        }

        .sl-download-btn:hover {
            transform: scale(1.05) translateY(-2px);
            background: #ef4444;
            color: white;
            box-shadow: 0 8px 20px rgba(192, 57, 43, 0.4);
        }

        .sl-download-btn:active {
            transform: scale(0.95);
        }

        .sl-download-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .sl-download-btn svg {
            width: 20px;
            height: 20px;
        }

        /* üî• Flatpickr Dark Mode - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô */
        [data-theme="dark"] .flatpickr-calendar {
            background: #1f2937;
            border: 1px solid #374151;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] .flatpickr-months {
            background: #1f2937;
        }

        [data-theme="dark"] .flatpickr-month {
            background: #1f2937;
            color: #f3f4f6;
        }

        [data-theme="dark"] .flatpickr-current-month {
            color: #f3f4f6;
        }

        [data-theme="dark"] .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: #1f2937 !important;
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] .flatpickr-current-month .numInputWrapper {
            background: #1f2937;
        }

        [data-theme="dark"] .flatpickr-current-month input.cur-year {
            color: #f3f4f6 !important;
            background: #1f2937;
        }

        [data-theme="dark"] .flatpickr-monthDropdown-months,
        [data-theme="dark"] .flatpickr-monthDropdown-month {
            background: #1f2937 !important;
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] select.flatpickr-monthDropdown-months {
            background: #1f2937 !important;
            color: #f3f4f6 !important;
            border-color: #4b5563;
        }

        [data-theme="dark"] .flatpickr-monthDropdown-months option {
            background: #1f2937 !important;
            color: #f3f4f6 !important;
        }

        [data-theme="dark"] .flatpickr-monthDropdown-months:hover,
        [data-theme="dark"] .numInputWrapper:hover {
            background: #374151 !important;
        }

        [data-theme="dark"] .flatpickr-day {
            color: #f3f4f6;
        }

        [data-theme="dark"] .flatpickr-day:hover {
            background: #374151 !important;
            border-color: #4b5563 !important;
        }

        [data-theme="dark"] .flatpickr-day.selected,
        [data-theme="dark"] .flatpickr-day.selected:hover {
            background: var(--primary) !important;
            border-color: var(--primary) !important;
            color: white !important;
        }

        [data-theme="dark"] .flatpickr-day.inRange {
            background: rgba(255, 107, 107, 0.2) !important;
            border-color: transparent !important;
        }

        [data-theme="dark"] .arrowUp,
        [data-theme="dark"] .arrowDown {
            border-bottom-color: #f3f4f6 !important;
        }

        [data-theme="dark"] span.arrowUp:after {
            border-bottom-color: #f3f4f6 !important;
        }

        [data-theme="dark"] span.arrowDown:after {
            border-top-color: #f3f4f6 !important;
        }

        [data-theme="dark"] .flatpickr-weekdays {
            background: #1f2937;
        }

        [data-theme="dark"] .flatpickr-weekday {
            background: #1f2937;
            color: #9ca3af;
        }

        [data-theme="dark"] .flatpickr-days {
            background: #1f2937;
        }

        /* üì± Mobile: Style Override */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
                gap: 15px;
                padding: 25px 20px;
            }
            .header-title {
                font-size: 24px;
            }
            .header-logo {
                width: 65px;
            }
            .search-section {
                padding: 15px;
                position: static;
            }
            .search-container {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            .search-input, .date-input, .btn-clear {
                width: 100% !important;
                min-width: 0;
                margin: 0;
            }
            .sub-gallery {
                grid-template-columns: 1fr 1fr;
                gap: 12px;
            }
            .news-img-wrapper {
                height: 130px;
            }
            .skeleton-card {
                height: 200px;
            }
            .skeleton-img {
                height: 130px;
            }
            .flatpickr-calendar {
                left: 50% !important;
                transform: translateX(-50%) !important;
                max-width: 90vw;
            }
            #btnBackToTop {
                bottom: 20px;
                right: 20px;
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            #btnThemeToggle {
                top: 20px;
                right: 20px;
                width: 40px;
                height: 40px;
            }

            /* üî• Mobile Override: ‡∏õ‡∏∏‡πà‡∏° Download ‡∏≠‡∏¢‡∏π‡πà‡∏•‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏≤‡∏á */
            .sl-download-btn {
                right: auto !important; 
                top: auto !important;
                position: fixed !important;
                bottom: 80px !important; 
                left: 0 !important;
                right: 0 !important;
                margin-left: auto !important;
                margin-right: auto !important;
                width: fit-content !important; 
                min-width: 140px;
                justify-content: center;
                padding: 10px 25px !important;
                z-index: 2147483647 !important;
                transform: none !important;
                border: 2px solid rgba(255, 255, 255, 0.9) !important;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6) !important;
            }
            .sl-download-btn:hover {
                transform: scale(1.05) !important;
            }

            .activity-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .activity-title {
                line-height: 1.4;
            }
            .btn-download-zip {
                width: 100%;
                justify-content: center;
                margin-top: 0;
            }
        }
    </style>
</head>

<body>

    <header class="header-container">
        <a href="login.html" class="logo-link" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà">
            <img src="Royal_Thai_Army_3_Logo.png" alt="‡∏ó‡∏†.3" class="header-logo" onerror="this.style.display='none'">
        </a>
        <div class="header-title">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏†.3</div>
    </header>

    <div class="search-section">
        <div class="search-container">
            <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."
                onkeyup="debouncedSearch()">
            <input type="text" id="dateRange" class="search-input date-input" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤...">
            <button onclick="resetFilter()" class="btn-clear">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
    </div>

    <div id="gallery" class="gallery-container"></div>
    <div id="scroll-sentinel"></div>
    <div id="loader" class="loader-spinner"></div>

    <button id="btnBackToTop" onclick="scrollToTop()" title="‡∏Å‡∏•‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
        </svg>
    </button>

    <button id="btnThemeToggle" onclick="toggleTheme()" title="‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î/‡∏™‡∏ß‡πà‡∏≤‡∏á">
    </button>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>
    <script>
        let allPhotos = [];
        let filteredPhotos = [];
        let currentDisplayCount = 0;
        const ITEMS_PER_PAGE = 12;
        let selectedDates = [];
        let isLoading = false;
        let searchTimeout;

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const target = current === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            updateThemeIcon(target);
        }
        function updateThemeIcon(theme) {
            const btn = document.getElementById('btnThemeToggle');
            if (theme === 'light') {
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0s.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41s1.03.39 1.41 0l1.06-1.06z"></path></svg>`;
            } else {
                btn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"></path></svg>`;
            }
        }
        initTheme();

        const datePicker = flatpickr("#dateRange", {
            mode: "range", dateFormat: "d/m/Y", locale: "th", disableMobile: "true",
            monthSelectorType: "dropdown",
            formatDate: (date, format, locale) => {
                const buddhistYear = date.getFullYear() + 543;
                return flatpickr.formatDate(date, format, locale).replace(date.getFullYear(), buddhistYear);
            },
            onChange: function (dates) { selectedDates = dates; resetAndFetch(); }
        });

        function getThumbnailUrl(url) {
            if (!url) return '';
            if (!url.includes('cloudinary.com')) return url;
            return url.replace('/upload/', '/upload/w_500,c_scale,q_auto,f_auto/');
        }

        function showSkeleton() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            const skeletonGrid = document.createElement('div');
            skeletonGrid.className = 'sub-gallery';
            for (let i = 0; i < 6; i++) {
                skeletonGrid.innerHTML += `
                    <div class="skeleton-card">
                        <div class="skeleton skeleton-img"></div>
                        <div class="skeleton skeleton-text"></div>
                    </div>
                `;
            }
            gallery.appendChild(skeletonGrid);
        }

        async function fetchPhotos() {
            try {
                showSkeleton();
                const response = await fetch('/public/photos?limit=100&t=' + Date.now());
                if (!response.ok) throw new Error('Network Error');
                allPhotos = await response.json();
                filteredPhotos = allPhotos;
                resetGallery();
            } catch (error) {
                console.error("Fetch Error:", error);
                document.getElementById('gallery').innerHTML = '<p style="text-align:center; color:#ef4444;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>';
            }
        }

        function debouncedSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { resetAndFetch(); }, 500);
        }

        function resetAndFetch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            filteredPhotos = allPhotos.filter(photo => {
                const matchName = (photo.filename || '').toLowerCase().includes(keyword) || (photo.activity || '').toLowerCase().includes(keyword);
                let matchDate = true;
                if (selectedDates.length > 0) {
                    const photoDate = new Date(photo.date).setHours(0, 0, 0, 0);
                    const startDate = new Date(selectedDates[0]).setHours(0, 0, 0, 0);
                    const endDate = (selectedDates.length > 1) ? new Date(selectedDates[1]).setHours(23, 59, 59, 999) : startDate;
                    matchDate = (photoDate >= startDate && photoDate <= endDate);
                }
                return matchName && matchDate;
            });
            resetGallery();
        }

        function resetGallery() {
            document.getElementById('gallery').innerHTML = '';
            currentDisplayCount = 0;
            document.getElementById('loader').style.display = 'none';
            if (filteredPhotos.length === 0) {
                document.getElementById('gallery').innerHTML = `
                    <div style="text-align:center; padding:50px; color:#94a3b8;">
                        <div style="font-size:40px; margin-bottom:10px;">üîç</div>
                        <div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>
                    </div>`;
            } else {
                loadMore();
            }
        }

        // üî• ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î ZIP ‡πÅ‡∏ö‡∏ö‡∏â‡∏•‡∏≤‡∏î (Smart Download)
        function downloadZip(activityName) {
            let url = `/download-zip/${encodeURIComponent(activityName)}`;
            
            // 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö LINE User Agent (‡πÄ‡∏ï‡∏¥‡∏° ?openExternalBrowser=1 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡∏¥‡∏î Chrome)
            const userAgent = navigator.userAgent || navigator.vendor || window.opera;
            if (/Line/i.test(userAgent)) {
                if (url.indexOf('?') === -1) url += '?openExternalBrowser=1';
                else url += '&openExternalBrowser=1';
                window.location.href = url;
                return;
            }

            // 2. ‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö Facebook/Instagram (‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô)
            if (/FBAN|FBAV|Instagram/i.test(userAgent)) {
                alert('‚ö†Ô∏è ‡πÅ‡∏≠‡∏õ‡∏ô‡∏µ‡πâ‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå\n\n1. ‡∏Å‡∏î‡∏ó‡∏µ‡πà‡∏à‡∏∏‡∏î 3 ‡∏à‡∏∏‡∏î‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô (...)\n2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå" (Open in Browser/Chrome/Safari)\n3. ‡∏Å‡∏î‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Ñ‡∏£‡∏±‡∏ö');
                return;
            }

            // 3. ‡∏õ‡∏Å‡∏ï‡∏¥ (Chrome/Safari)
            window.location.href = url;
        }

        function loadMore() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('loader').style.display = 'block';

            setTimeout(() => {
                const galleryContainer = document.getElementById('gallery');
                const nextPhotos = filteredPhotos.slice(currentDisplayCount, currentDisplayCount + ITEMS_PER_PAGE);

                if (nextPhotos.length === 0) {
                    document.getElementById('loader').style.display = 'none';
                    isLoading = false;
                    return;
                }

                const groupedPhotos = {};
                nextPhotos.forEach(photo => {
                    const activityName = photo.activity || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                    if (!groupedPhotos[activityName]) groupedPhotos[activityName] = [];
                    groupedPhotos[activityName].push(photo);
                });

                for (const [activityName, activityPhotos] of Object.entries(groupedPhotos)) {
                    let section = document.getElementById(`sec-${activityName}`);
                    let grid;

                    if (!section) {
                        section = document.createElement('div');
                        section.className = 'activity-section';
                        section.id = `sec-${activityName}`;
                        
                        // üî• ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ downloadZip() ‡πÅ‡∏ö‡∏ö JS
                        section.innerHTML = `
                            <div class="activity-header">
                                <h2 class="activity-title">${activityName}</h2>
                                <button onclick="downloadZip('${activityName}')" class="btn-download-zip">üì• Download ZIP</button>
                            </div>
                            <div class="sub-gallery"></div>
                        `;
                        galleryContainer.appendChild(section);
                    }
                    grid = section.querySelector('.sub-gallery');

                    activityPhotos.forEach(photo => {
                        const rawName = photo.filename || "";
                        const dateStr = new Date(photo.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: '2-digit' });
                        const thumbUrl = getThumbnailUrl(photo.url);
                        const originalUrl = photo.original_url || photo.url;

                        const card = document.createElement('a');
                        card.className = 'news-card';
                        card.href = originalUrl;

                        card.innerHTML = `
                            <div class="news-img-wrapper">
                                <img src="${thumbUrl}" alt="${rawName}" loading="lazy" 
                                     onload="this.classList.add('loaded')"
                                     onerror="this.src='data:image/svg+xml;base64,...'">
                            </div>
                            <div class="news-info">
                                <div class="news-date">üìÖ ${dateStr}</div>
                            </div>
                        `;
                        grid.appendChild(card);
                    });
                }

                currentDisplayCount += nextPhotos.length;
                document.getElementById('loader').style.display = 'none';
                isLoading = false;

                // Lightbox & Download Button
                const galleries = document.querySelectorAll('.sub-gallery');
                galleries.forEach(gallery => {
                    if (gallery.myLightbox) {
                        gallery.myLightbox.refresh();
                    } else {
                        gallery.myLightbox = new SimpleLightbox(gallery.querySelectorAll('a'), {
                            captionsData: 'alt',
                            captionDelay: 250,
                            animationSpeed: 200
                        });

                        const updateDownloadButton = () => {
                            setTimeout(() => {
                                const img = document.querySelector('.sl-image img');
                                if (!img) return; 

                                let btn = document.querySelector('.sl-download-btn');
                                
                                if (!btn) {
                                    btn = document.createElement('button');
                                    btn.className = 'sl-download-btn';
                                    btn.innerHTML = `
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="7 10 12 15 17 10"></polyline>
                                            <line x1="12" y1="15" x2="12" y2="3"></line>
                                        </svg>
                                        Download
                                    `;
                                    btn.onclick = async function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        const imageUrl = img.src;
                                        const fileName = imageUrl.split('/').pop().split('?')[0] || 'photo.jpg';
                                        
                                        try {
                                            // Show loading
                                            const originalHTML = btn.innerHTML;
                                            btn.innerHTML = `
                                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <circle cx="12" cy="12" r="10" opacity="0.25"/>
                                                    <path d="M12 2a10 10 0 0 1 10 10" opacity="1">
                                                        <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
                                                    </path>
                                                </svg>
                                                ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                                            `;
                                            btn.disabled = true;
                                            
                                            const response = await fetch(imageUrl);
                                            const blob = await response.blob();
                                            const blobUrl = window.URL.createObjectURL(blob);
                                            
                                            const a = document.createElement('a');
                                            a.href = blobUrl;
                                            a.download = fileName;
                                            document.body.appendChild(a);
                                            a.click();
                                            document.body.removeChild(a);
                                            window.URL.revokeObjectURL(blobUrl);
                                            
                                            // Restore button
                                            btn.innerHTML = originalHTML;
                                            btn.disabled = false;
                                        } catch (error) {
                                            console.error('Download failed:', error);
                                            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                                            btn.innerHTML = `
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                                    <polyline points="7 10 12 15 17 10"></polyline>
                                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                                </svg>
                                                Download
                                            `;
                                            btn.disabled = false;
                                        }
                                    };
                                    document.body.appendChild(btn);
                                }
                                btn.style.display = 'flex'; 
                            }, 100); 
                        };

                        gallery.myLightbox.on('shown.simplelightbox', updateDownloadButton);
                        gallery.myLightbox.on('changed.simplelightbox', updateDownloadButton);
                        gallery.myLightbox.on('close.simplelightbox', function () {
                            const btn = document.querySelector('.sl-download-btn');
                            if (btn) btn.style.display = 'none';
                        });
                    }
                });

            }, 300);
        }

        function resetFilter() {
            document.getElementById('searchInput').value = '';
            datePicker.clear();
            resetAndFetch();
        }

        window.onscroll = function () {
            const btn = document.getElementById("btnBackToTop");
            if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                btn.style.display = "flex";
            } else {
                btn.style.display = "none";
            }
        };

        function scrollToTop() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        const observer = new IntersectionObserver((entries) => {
            if (entries[0].isIntersecting && !isLoading && currentDisplayCount < filteredPhotos.length) {
                loadMore();
            }
        }, { rootMargin: '100px' });

        observer.observe(document.getElementById('scroll-sentinel'));

        fetchPhotos();
    </script>
</body>

</html>