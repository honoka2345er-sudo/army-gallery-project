<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏ö.3</title>

    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/th.js"></script>

    <style>
        /* --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô --- */
        body {
            font-family: 'Sarabun', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            display: block;
            overflow-y: auto;
        }

        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏±‡∏ß‡πÄ‡∏ß‡πá‡∏ö (Header) --- */
        .header-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 25px 20px;
            background-color: white;
            position: relative;
            border-bottom: 1px solid #eee;
            gap: 20px;
        }

        .header-logo {
            width: 80px;
            height: auto;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .header-logo:hover {
            transform: scale(1.05);
        }

        .header-title {
            font-size: 28px;
            margin: 0;
            color: #333;
            font-weight: bold;
        }

        /* --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ --- */
        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            position: relative;
        }

        .search-input {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14px;
        }

        /* --- Grid ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ --- */
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            padding: 30px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .news-card {
            display: block;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            background: #fff;
            transition: transform 0.2s;
            text-decoration: none;
            color: #333;
        }

        .news-card:hover {
            transform: translateY(-5px);
        }

        .news-img-wrapper {
            width: 100%;
            height: 200px;
            overflow: hidden;
        }

        .news-img-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }

        .news-card:hover img {
            transform: scale(1.05);
        }

        /* ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° */
        #loadMoreContainer button {
            padding: 12px 40px;
            background: #2c3e50;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-size: 16px;
            transition: 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* --- Mobile Responsive (‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠) --- */
        @media (max-width: 768px) {
            .header-container {
                flex-direction: column;
                text-align: center;
                gap: 10px;
                padding: 20px;
            }

            .header-logo {
                width: 70px;
            }

            .header-title {
                font-size: 22px;
            }

            .search-section {
                flex-direction: column;
                padding: 20px;
            }

            .search-input {
                width: 100% !important;
                margin: 0;
                box-sizing: border-box;
                height: 45px;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö Grid ‡πÄ‡∏õ‡πá‡∏ô 2 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ */
            .gallery {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                padding: 15px;
            }

            .news-img-wrapper {
                height: 130px;
            }

            .news-title {
                padding: 8px;
                font-size: 11px;
            }

            #loadMoreContainer button {
                width: 100%;
                padding: 15px;
            }

            /* ‡∏õ‡∏£‡∏±‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏ß‡πÑ‡∏°‡πà‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ */
            .activity-title {
                font-size: 18px !important;
            }
        }
    </style>
</head>

<body>

    <header class="header-container">
        <a href="login.html" title="‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà">
            <img src="Royal_Thai_Army_3_Logo.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
        </a>
        <h1 class="header-title">‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå ‡∏ó‡∏ö.3</h1>
    </header>

    <div class="search-section">
        <input type="text" id="searchInput" class="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°..."
            onkeyup="resetAndFetch()" style="width: 350px;">
        <input type="text" id="dateRange" class="search-input" placeholder="üìÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤..."
            style="width: 220px; text-align: center;">
        <button onclick="resetFilter()"
            style="padding: 12px 25px; border: none; background: #95a5a6; color: white; border-radius: 5px; cursor: pointer; font-size: 14px;">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div id="gallery">
        <p style="text-align: center; padding: 20px; color: #666; width: 100%;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£...</p>
    </div>

    <div id="loadMoreContainer" style="text-align:center; margin: 40px; display:none;">
        <button onclick="loadMore()">‚¨áÔ∏è ‡∏î‡∏π‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/simplelightbox/2.14.2/simple-lightbox.min.js"></script>

    <script>
        let allPhotos = [];
        let filteredPhotos = [];
        let currentDisplayCount = 0;
        const ITEMS_PER_PAGE = 12;
        let lightbox;
        let selectedDates = [];

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        const datePicker = flatpickr("#dateRange", {
            mode: "range",
            dateFormat: "Y-m-d",
            locale: "th",
            onClose: function (dates) {
                selectedDates = dates;
                resetAndFetch();
            }
        });

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡πá‡∏ß (‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•)
        function getThumbnailUrl(url) {
            if (!url) return '';
            if (!url.includes('cloudinary.com')) return url;
            // ‡∏™‡∏±‡πà‡∏á Cloudinary ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å (w_450)
            return url.replace('/upload/', '/upload/w_450,c_scale,q_auto,f_auto/');
        }
        async function fetchPhotos() {
            try {
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° timestamp ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô Cache
                const response = await fetch('/photos?limit=100&t=' + Date.now());

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allPhotos = await response.json();
                console.log('‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', allPhotos.length, '‡∏£‡∏π‡∏õ');

                filteredPhotos = allPhotos;
                resetGallery();
            } catch (error) {
                console.error('‚ùå Error loading photos:', error);
                document.getElementById('gallery').innerHTML = '<p style="text-align:center; color:red;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ</p>';
            }
        }
        function resetAndFetch() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();

            filteredPhotos = allPhotos.filter(photo => {
                const matchName = photo.filename.toLowerCase().includes(keyword) || (photo.activity && photo.activity.toLowerCase().includes(keyword));

                let matchDate = true;
                if (selectedDates.length > 0) {
                    const photoDate = new Date(photo.date).setHours(0, 0, 0, 0);
                    const startDate = selectedDates[0].setHours(0, 0, 0, 0);
                    const endDate = (selectedDates.length > 1) ? selectedDates[1].setHours(23, 59, 59, 999) : startDate;
                    matchDate = (photoDate >= startDate && photoDate <= endDate);
                }
                return matchName && matchDate;
            });
            resetGallery();
        }

        function resetGallery() {
            document.getElementById('gallery').innerHTML = '';
            currentDisplayCount = 0;

            if (filteredPhotos.length === 0) {
                document.getElementById('gallery').innerHTML = '<p style="text-align: center; padding: 40px; color: #999; width: 100%;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç</p>';
                document.getElementById('loadMoreContainer').style.display = 'none';
            } else {
                loadMore();
            }
        }

        function loadMore() {
            const galleryContainer = document.getElementById('gallery');
            const nextPhotos = filteredPhotos.slice(currentDisplayCount, currentDisplayCount + ITEMS_PER_PAGE);

            if (nextPhotos.length === 0) return;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
            const groupedPhotos = {};
            nextPhotos.forEach(photo => {
                const activityName = photo.activity || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ';
                if (!groupedPhotos[activityName]) {
                    groupedPhotos[activityName] = [];
                }
                groupedPhotos[activityName].push(photo);
            });

            // ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡∏•‡∏∏‡πà‡∏°
            for (const [activityName, activityPhotos] of Object.entries(groupedPhotos)) {
                let section = document.getElementById(`sec-${activityName}`);
                let grid;

                if (!section) {
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á)
                    section = document.createElement('div');
                    section.className = 'activity-section';
                    section.id = `sec-${activityName}`;
                    section.style.gridColumn = "1 / -1";

                    const headerDiv = document.createElement('div');
                    headerDiv.style.cssText = 'display:flex; align-items:center; gap:15px; margin: 30px 0 15px 0; border-bottom: 2px solid #e74c3c; padding-bottom: 10px;';

                    const title = document.createElement('h2');
                    title.className = 'activity-title';
                    title.style.margin = '0';
                    title.style.color = '#c0392b';
                    title.innerText = activityName;

                    const zipBtn = document.createElement('a');
                    zipBtn.href = `/download-zip/${encodeURIComponent(activityName)}`;
                    zipBtn.innerHTML = 'üì• ‡πÇ‡∏´‡∏•‡∏î ZIP';
                    zipBtn.style.cssText = 'font-size:12px; color:#fff; background:#c0392b; padding:5px 15px; border-radius:20px; text-decoration:none; transition:0.2s; white-space: nowrap;';

                    headerDiv.appendChild(title);
                    headerDiv.appendChild(zipBtn);
                    section.appendChild(headerDiv);

                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Grid ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                    grid = document.createElement('div');
                    grid.style.display = "grid";
                    grid.style.gridTemplateColumns = "repeat(auto-fill, minmax(280px, 1fr))";
                    grid.style.gap = "20px";
                    grid.className = 'sub-gallery';

                    section.appendChild(grid);
                    galleryContainer.appendChild(section);
                } else {
                    grid = section.querySelector('.sub-gallery');
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                activityPhotos.forEach(photo => {
                    const rawName = photo.filename || photo.file_name || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏û";
                    const newsTitle = rawName.replace ? rawName.replace(/\.[^/.]+$/, "") : rawName;
                    const dateObj = new Date(photo.date);
                    const dateStr = dateObj.toLocaleDateString('th-TH', {
                        day: 'numeric',
                        month: 'short',
                        year: '2-digit'
                    });

                    const card = document.createElement('a');
                    card.className = 'news-card';

                    // ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏õ‡∏£‡∏π‡∏õ‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö (‡∏ä‡∏±‡∏î‡πÄ‡∏õ‡πä‡∏∞)
                    card.href = photo.original_url || photo.url;

                    // ‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏¢‡πà‡∏≠ (‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß)
                    const thumbUrl = getThumbnailUrl(photo.url);

                    console.log('üñºÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î:', newsTitle, 'URL:', thumbUrl);

                    card.innerHTML = `
                        <div class="news-img-wrapper">
                            <img src="${thumbUrl}" 
                                 alt="${newsTitle}" 
                                 loading="lazy" 
                                 onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E';">
                        </div>
                        <div class="news-title" style="text-align:left; padding:15px; height:auto;">
                            <span style="font-size:14px; color:#7f8c8d;">üìÖ ${dateStr}</span>
                        </div>
                    `;
                    grid.appendChild(card);
                });
            }

            currentDisplayCount += nextPhotos.length;

            // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°
            if (currentDisplayCount >= filteredPhotos.length) {
                document.getElementById('loadMoreContainer').style.display = 'none';
            } else {
                document.getElementById('loadMoreContainer').style.display = 'block';
            }

            // Refresh Lightbox
            if (lightbox) {
                lightbox.refresh();
            } else {
                lightbox = new SimpleLightbox('.sub-gallery a', {
                    captionsData: 'alt',
                    captionDelay: 250,
                    animationSpeed: 200
                });
            }
        }

        function resetFilter() {
            document.getElementById('searchInput').value = '';
            datePicker.clear();
            resetAndFetch();
        }

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
        fetchPhotos();
    </script>
</body>

</html>